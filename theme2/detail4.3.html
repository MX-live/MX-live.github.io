<!doctype html>
<html lang="zh">

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<title>Mingxin.live</title>
		<meta name="description" content="" />
		<meta name="keywords" content="" />
		<link rel="stylesheet" type="text/css" href="statics/css/index.css" media="all" />
		<link rel="stylesheet" type="text/css" href="statics/css/detail.css" />
	</head>

	<body class="home blog custom-background round-avatars" itemscope itemtype="http://schema.org/Organization">
		<div class="Yarn_Background" style="background-image: url( statics/images/47fb3c_.jpg);"></div>
		<form class="js-search search-form search-form--modal" method="get" action="search.html" role="search">
			<div class="search-form__inner">
				<div>
					<div id="search-container" class="ajax_search">
						<form method="get" id="searchform" action="">
							<div class="filter_container"><input type="text" value="" autocomplete="off" placeholder="Type then select or enter" name="s" id="search-input" />
								<ul id="search_filtered" class="search_filtered"></ul>
							</div>
							<input type="submit" name="submit" id="searchsubmit" class="searchsubmit" value="" />
						</form>
					</div>
				</div>
			</div>
		</form>
		<div class="navi" data-aos="fade-down">
			<div class="bt-nav">
				<div class="line line1"></div>
				<div class="line line2"></div>
				<div class="line line3"></div>
			</div>
			<div class="navbar animated fadeInRight">
				<div class="inner">
					<nav id="site-navigation" class="main-navigation">
						<div id="main-menu" class="main-menu-container">
							<div class="menu-menu-container">
								<ul id="primary-menu" class="menu">
									<li id="menu-item-17" class="menu-item menu-item-type-custom menu-item-object-custom current-menu-item current_page_item menu-item-home menu-item-17">
										<a href="index4.html">上级首页</a>
									</li>
									<li id="menu-item-173" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-173">
										<a href="update.html">更新</a>
									</li>
									<li id="menu-item-78" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-78">
										<a href="link.html">链接</a>
									</li>
									<li id="menu-item-252" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-252">
										<a href="archives.html">归档</a>
										<ul class="sub-menu">
											<li id="menu-item-165" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-165">
												<a href="">theme</a>
											</li>
											<li id="menu-item-163" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-163">
												<a href="">Happen</a>
											</li>
											<li id="menu-item-924" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-924">
												<a href="">WeWork</a>
											</li>
											<li id="menu-item-164" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-164">
												<a href="">WordPress</a>
											</li>
										</ul>
									</li>
									<li id="menu-item-57" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-57">
										<a href="gustbook.html">留言</a>
									</li>
								</ul>
							</div>
						</div>
					</nav>
					<!-- #site-navigation -->
				</div>
			</div>
		</div>
		<div class="hebin" data-aos="fade-down">
			<i class=" js-toggle-search iconfont">&#xe60e;</i>
		</div>
		<header id="masthead" class="overlay animated from-bottom" itemprop="brand" itemscope itemtype="http://schema.org/Brand">
			<div class="site-branding text-center">
				<a href="">
					<figure>
						<img class="custom-logo avatar" src="statics/images/omikron.png" />
					</figure>
				</a>
				<h3 class="blog-description"><p>Ming Xin.live</p></h3>
			</div>
			<!-- .site-branding -->
			<div class="decor-part">
				<div id="particles-js"></div>
			</div>
			<div class="animation-header">
				<div class="decor-wrapper">
					<svg id="header-decor" class="decor bottom" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 100 100" preserveAspectRatio="none">
						<path class="large left" d="M0 0 L50 50 L0 100" fill="rgba(255,255,255, .1)"></path>
						<path class="large right" d="M100 0 L50 50 L100 100" fill="rgba(255,255,255, .1)"></path>
						<path class="medium left" d="M0 100 L50 50 L0 33.3" fill="rgba(255,255,255, .3)"></path>
						<path class="medium right" d="M100 100 L50 50 L100 33.3" fill="rgba(255,255,255, .3)"></path>
						<path class="small left" d="M0 100 L50 50 L0 66.6" fill="rgba(255,255,255, .5)"></path>
						<path class="small right" d="M100 100 L50 50 L100 66.6" fill="rgba(255,255,255, .5)"></path>
						<path d="M0 99.9 L50 49.9 L100 99.9 L0 99.9" fill="rgba(255,255,255, 1)"></path>
						<path d="M48 52 L50 49 L52 52 L48 52" fill="rgba(255,255,255, 1)"></path>
					</svg>
				</div>
			</div>
		</header>
		<div id="main" class="content">
			<div class="container">
				<article id="post-1202" class="js-gallery post-1202 post type-post status-publish format-standard has-post-thumbnail hentry category-uncategorized tag-11 tag-22 tag-29">
					<style>
						.container {
							padding: 10px 0px;
						}
						
						.post {
							margin: 0 auto
						}
					</style>
					<section class="post_content">
						<header class="post_header">
							<h1 class="post_title">任意地址写</h1>
						</header>
						<div class="post-body js-gallery">
							<h1 id="前言">前言</h1> 
				<p>本篇主要讲解 通过任意地址写，改变程序执行流程，执行设计的指令和操作，以及格式化字符串漏洞的原理和其利用的例子。</p> 
				<h1>一：任意地址写利用流程分析</h1>
				<p>这里通过一张流程图来分析本次实验的内容</p>
				<img src="index4/4.3/4.3.1.jpg">
				<h1>二：任意地址写利用具体实验过程</h1>
				<h2>2.1：先发现存在任意地址写</h2>
				<img src="index4/4.3/4.3.2.jpg">
				<p>分析代码容易发现，在给整型数组a[ ]赋值时，当输入的idx大于9时，就会造成任意地址写</p>
				<h2>2.2：分析是否可以改变程序流程</h2>
				<p>要改变程序流程的方法有，改函数的got表地址，改函数的返回地址等，这里通过使用puts函数的plt地址覆盖fun函数的返回地址，来改变程序的执行流程。</p>
				<h2>2.3：泄露puts函数的真实地址</h2>
				<p>上文已经说到，通过puts函数的plt地址覆盖fun函数的返回地址，执行puts函数来改变程序的执行流程，然后将puts函数的真实地址打印出来，那当idx的值为多少时能覆盖fun函数的返回地址？
				方法很多，这里通过gdb调试，先输入一个idx的值找到输入idx的值的地址，再计算到返回地址需要多少个字节可以刚好覆盖返回地址</p>
				<h3>2.3.1：调试找到第一次输入idx值的地方</h3>
				<p>第一次先给index值为0，content值为2147483647，之所以这样做是为了是数组a的第一个值a[0]值为0x7fffffff（也可以给content赋其他值，这里这样赋值是为了方便后面寻找），通过调试找到了当idx的值为14时，可以覆盖fun函数的返回地址</p>
			<h3>	2.3.2：计算出idx的之后，构造payload</h3>
			<p>将puts函数的plt地址覆盖fun函数的返回地址（为了执行puts函数打印puts函数的真实地址），接下来是fun函数的地址（为了再一次执行fun函数），再接下来是puts函数的got表地址（puts函数的got表地址指向的puts函数的真实地址）</p>
			<img src="index4/4.3/4.3.4.jpg">
				<h2>2.4：计算基址，设计执行命令</h2>
				<p>上文已经说到，将puts函数的真实地址已经打印出来了，而且打印之后再一次执行了fun函数，现在要做的是利用puts函数的真实地址计算基址，通过基址计算得到system函数和/bin/sh的地址，然后将计算出来的system函数的地址像刚打印puts函数真实地址一样赋值给content，覆盖fun函数的返回地址，执行/bin/sh</p>
				<img src="index4/4.3/4.3.5.jpg">
			<h2>2.5：得到shell</h2>
			<img src="index4/4.3/4.3.6.jpg">
			<h1>三：格式化字符串漏洞简介</h1>
			<h2>3.1：格式化字符串函数</h2>
			<p>常见的格式化字符串函数有：</p>
			<p><strong>输入：scanf</strong></p>
			<p><strong>输出：</strong></p>
			<table>
				<thead>
				<tr>
				<th >函数</th>
				<th >基本介绍</th>
				</tr>
				</thead>
				<tbody>
				<tr>
				<td > printf</td>
				<td > 输出到 stdout</td>
				</tr>
				<tr>
				<td >fprintf</td>
				<td > 输出到指定 FILE 流</td>
				</tr>
				<tr>
				<td > vprintf</td>
				<td > 根据参数列表格式化输出到 stdout</td>
				</tr>
				<tr>
				<td >vfprintf</td>
				<td > 根据参数列表格式化输出到指定 FILE 流</td>
				</tr>
				<tr>
				<td > sprintf</td>
				<td > 输出到字符串</td>
				</tr>
				<tr>
				<td > snprintf</td>
				<td > 输出指定字节数到字符串</td>
				</tr>
				<tr>
				<td > vsprintf</td>
				<td > 根据参数列表格式化输出到字符串</td>
				</tr>
				<tr>
				<td > vsnprintf</td>
				<td > 根据参数列表格式化输出指定字节到字符串</td>
				</tr>
				<tr>
				<td > setproctitle</td>
				<td > 设置 argv</td>
				</tr>
				<tr>
				<td >syslog</td>
				<td > 输出日志</td>
				</tr>
				</tbody>
				</table>
				<h2>3.2：格式化字符串漏洞的原理</h2>
				<p>格式化字符串函数可以接受可变数量的参数，并将第一个参数作为格式化字符串，根据其来解析之后的参数。一般来说，格式化字符串在利用的时候主要分为三个部分:</p>
				<ul>
					<li>●格式化字符串函数</li>
					<li>●格式化字符串</li>
					<li>●后续参数，可选</li>
				</ul>
				<p>	举例：</p>
				<img src="index4/4.3/4.3.7.jpg">
				<p>将例子中的函数编译，gdb调试，断点下在printf函数这里，run运行后，输入 %08x.%08x.%08x（即给s赋值为 %08x.%08x.%08x），运行结果如下：</p>
				<img src="index4/4.3/4.3.8.jpg">
				<p>栈上的布局由高地址到低地址（栈顶为函数的最低地址）</p>
				<ol>
					<li>函数的返回地址</li>
					<li>格式化字符串%08x.%08x.%08x的地址</li>
					<li>第三个变量为 a 的值</li>
					<li>第四个变量为 b 的值</li>
					<li>第五个变量为 c 的值</li>
					<li>第六个变量为我们输入的格式化字符串对应的地址</li>
				</ol>
				<p>继续运行程序，输出结果如下：</p>
				<img src="index4/4.3/4.3.9.jpg">
				<p>在进入printf函数后，首先会获取第一个参数，一个一个读取字符会遇到一下两种情况。</p>
				<h3>1：当前字符不是 %，直接输出到相应标准输出。</h3>
				<h3>当前字符是 %， 继续读取下一个字符，下一个字符：</h3>
					<ul>
					<li>● 如果没有字符，报错</li>
					<li>●如果下一个字符是 %, 输出 %</li>
					<li>●否则根据相应的字符，获取相应的参数，对其进行解析并输出</li>
				</ul>
				<p>上文提到程序第一次输出后，确实输出了每一个变量对应的数值，并且断在了下一个 printf 处，此时，由于格式化字符串为 %x%x%x，所以，按照上文所述获取参数的过程，程序会将栈上的 0xffffd200 及其之后的两个数值分别作为第一，第二，第三个参数按照 int 型进行解析，分别输出。继续运行程序，输出结果如下</p>
				<img src="index4/4.3/4.3.10.jpg">
				<p>可以看到函数将栈上的 0xffffd200 及其之后的两个数值按照 int 型进行解析输出了</p>
				<p><strong>自此，我们结合实例阐明了格式化字符串漏洞的基本原理</strong></p>
				<h2>3.3：格式化字符串参数的利用</h2>
				<ol>
					<li>利用 %x 来获取对应栈的内存，但建议使用 %p，可以不用考虑位数的区别。</li>
					<li>利用 %s 来获取变量所对应地址的内容，只不过有零截断。</li>
					<li>利用 %[order]$x 来获取指定参数的值，利用 %[order]$s 来获取指定参数对应地址的内容，可用于读取GOT表等信息。(order 为数字用来指定位置)</li>
					<li>利用%n将%n之前printf已经打印的字符个数赋值给偏移处指针所指向的地址位置，如%100×10$n表示将0x64写入偏移10处保存的指针所指向的地址（4字节），而%$hn表示写入的地址空间为2字节，%$hhn表示写入的地址空间为1字节，%$lln表示写入的地址空间为8字节，在32bit和64bit环境下一样。有时，直接写4字节会导致程序崩溃或等候时间过长，可以通过%$hn或%$hhn来适时调整</li>
				</ol>
				<h1>四：格式化字符串漏洞的利用</h1>
				<h2>4.1：利用流程如图</h2>
				<img src="index4/4.3/4.3.10.jpg">
				<h2>4.2：详细利用过程</h2>
				<h3>4.2.1：通过格式化字符串漏洞找到保护地址</h3>
				<p>首先确定保护，checksec 文件名，检查结果如图：</p>
				<img src="index4/4.3/4.3.11.jpg">
				<p>发现存在Canary 保护机制，关于Canary 保护机制，这里有详细的介绍和解释：https://ctf-wiki.github.io/ctf-wiki/pwn/linux/mitigation/canary/</p>
				<p>GDB调试，断点下在puts函数处，run运行以后，continue输出AAAAAAAA，通过调试找到Canary返回地址的偏移地址，得到偏移为31个地址（此处可能有待商榷）</p>
				<h3>4.2.2：任意地址写</h3>
				<p>在上文中已经获取保护地址（命名为cookie，后面直接引用该命名），通过调试查看需要多少个字节才能覆盖fun函数的返回地址，gdb调试计算从输入到返回地址需要覆盖62个‘a’，注意50个‘a’后即为保护地址，用puts函数的plt地址覆盖返回地址，改变程序流程，执行puts函数，参数为puts函数的got表地址，这样便可把puts函数的真实地址打印出来，造成函数地址泄露。得到puts函数的真实地址之后，再通过libc库计算基址和shell函数的地址。</p>
				<h3>再次执行fun函数，执行shell命令</h3>
				<p>在上文中，发送payload，执行完puts函数，完成地址泄露后，就要再次执行fun函数</p>
				<img src="index4/4.3/4.3.16.jpg">
				<p>然后同样的首发再次发送payload，用system函数的地址覆盖fun函数的返回地址。这里需要注意的是，再次执行时fun函数时，要先发送一个“a”完成fun函数的第一个read功能。</p>
				<h3>返回shell，执行命令</h3>
				<img src="index4/4.3/4.3.17.jpg">

   
    
    










						<div class="meta split split--responsive cf">
							<div class="split__title">
								<time datetime="2019-03">2019-03</time>
								<span class=""><a href="" rel="tag">主题</a><a href="" rel="tag">日常</a><a href="" rel="tag">更新</a> </span>
							</div>
							<div id="social-share"><span class="entypo-share"><i class="iconfont">&#xe614;</i>分享</span></div>
							<div class="slide">
								<a class="btn-slide" title="switch down"><i class="iconfont">&#xe615;</i>折叠评论区</a>
							</div>
						</div>
					</section>
				</article>
			</div>
			<svg id="upTriangleColor" width="100%" height="40" viewBox="0 0 100 102" preserveAspectRatio="none">
				<path d="M0 0 L50 100 L100 0 Z"></path>
			</svg>
			<div id="social">
				<ul>
					<li>
						<a href="" title="qzone" target="_blank"><i class="iconfont">&#xe67f;</i></a>
					</li>
					<li>
						<a href="" title="weibo" target="_blank"><i class="iconfont">&#xe680;</i></a>
					</li>
					<li>
						<a href="" title="douban" target="_blank"><i class="iconfont">&#xe681;</i></a>
					</li>
					<li>
						<a href="" title="twitter" target="_blank"><i class="iconfont">&#xe683;</i></a>
					</li>
				</ul>
			</div>
			<div id="panel">
				<div class="comment-area">
				
							</ul>
							<nav id="comments-navi">
								<a class="prev page-numbers" href="">
									<</a>
										<a class='page-numbers' href="">1</a>
										<a class='page-numbers' href="">2</a>
										<a class='page-numbers' href="">3</a>
										<span aria-current='page' class='page-numbers current'>4</span></nav>
							<div id="respond" class="comment-respond">
								<h6 id="replytitle" class="comment-reply-title"><a rel="nofollow" id="cancel-comment-reply-link" href="" style="display:none;">取消</a></h6>
								<form action="#" method="post" id="commentform" class="clearfix">
									<div class="clearfix"></div>
									<div class="author-info">
										<input type="text" name="author" id="author" placeholder="昵  称 : " value="" tabindex="1" title="Name (required)" />
										<input type="text" name="email" id="email" placeholder="邮  箱 : " value="" tabindex="2" title="E-mail(will not be published) required" />
										<input type="text" name="url" id="url" placeholder="网  址 : " value="" tabindex="3" title="Website" />
									</div>
									<div class="clearfix"></div>
									<input type='hidden' name='comment_post_ID' value='1202' id='comment_post_ID' />
									<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
									<p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="632104fca1" /></p>
									<p style="display: none;"><input type="hidden" id="ak_js" name="ak_js" value="87" /></p>
									<div class="comment-form-info">
										<div class="real-time-gravatar"> <img id="real-time-gravatar" src="statics/images/d41d8cd98f00b204e9800998ecf8427e.png" alt="gravatar头像" />
										</div>
										<p class="input-row">
											<i class="row-icon"></i>
											<textarea class="text_area" rows="3" cols="80" name="comment" id="comment" tabindex="4" placeholder="你不说两句吗？(°∀°)ﾉ……"></textarea>
											<input type="submit" name="submit" class="button" id="submit" tabindex="5" value="发送" />
										</p>
									</div>
								</form>
							</div>
						</div>
					</section>
				</div>
			</div>
			<svg id="dwTriangleColor" width="100%" height="40" viewBox="0 0 100 102" preserveAspectRatio="none">
				<path d="M0 0 L50 100 L100 0 Z"></path>
			</svg>
			<div class="wrapper">
			</div>
		</div>

		<div class="p-header">
			<figure class="p-image" style="background-image: url(statics/images/47fb3c_9afed6c259f94589881bd55376206366mv2_d_3840_5784_s_4_2.jpg);"></figure>
		</div>
		<div class="navpost-part">
			<div id="NextPrevPosts">
				<div class="prev" data-aos="slide-right" data-aos-delay="1.5s">
					<div class="arrow"><i class="iconfont">&#xe625;</i></div>
					<div class="preview">
						<div class="pull-left featuredImg" style="background-image:url('statics/images/mx.jpg');"></div>
						<a class="pull-left preview-content bold" href="index4.html"><span><font color="DarkBlue">点击回到上一级</font></span></a>
					</div>
				</div>
				<div class="next" data-aos="slide-left" data-aos-delay="1.5s">
					<div class="arrow"><i class="iconfont">&#xe623;</i></div>
					<div class="preview">
						<div class="pull-right featuredImg" style="background-image:url('statics/images/mx.jpg');"></div>
						<a class="pull-right preview-content bold" href="../index.html"><span><font color="DarkBlue">点击回到主页</font></span></a>
					</div>
				</div>
			</div>
		</div>

		<footer id="footer" class="overlay animated from-top">
			<div class="decor-wrapper">
				<svg id="footer-decor" class="decor top" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 100 100" preserveAspectRatio="none">
					<path class="large left" d="M0 0 L50 50 L0 100" fill="rgba(255,255,255, .1)"></path>
					<path class="large right" d="M100 0 L50 50 L100 100" fill="rgba(255,255,255, .1)"></path>
					<path class="medium left" d="M0 0 L50 50 L0 66.6" fill="rgba(255,255,255, .3)"></path>
					<path class="medium right" d="M100 0 L50 50 L100 66.6" fill="rgba(255,255,255, .3)"></path>
					<path class="small left" d="M0 0 L50 50 L0 33.3" fill="rgba(255,255,255, .5)"></path>
					<path class="small right" d="M100 0 L50 50 L100 33.3" fill="rgba(255,255,255, .5)"></path>
					<path d="M0 0 L50 50 L100 0 L0 0" fill="rgba(255,255,255, 1)"></path>
					<path d="M48 48 L50 51 L52 48 L48 48" fill="rgba(255,255,255, 1)"></path>
				</svg>
			</div>
			<div class="socialize" data-aos="zoom-in">
				<li>
					<a title="weibo" class="socialicon" href=""><i class="iconfont" aria-hidden="true">&#xe601;
			</i></a>
				</li>
				<li class="wechat">
					<a class="socialicon"><i class="iconfont">&#xe609;
			</i></a>
					<div class="wechatimg"><img src="statics/images/49D3746D-7519-B709-83E4-65BD1927C4E7.jpg"></div>
				</li>
				<li>
					<a title="QQ" class="socialicon" href="" target="_blank"><i class="iconfont" aria-hidden="true">&#xe616;
			</i></a>
				</li>
			</div>
			<div class="cr">Copyright&copy; 2018. Design by
				<a href="">17sucai</a>
			</div>
			<script type="text/javascript">
				window.onscroll = function() {
					var scrollTop = document.body.scrollTop;
					if(scrollTop >= 200) {
						document.getElementById("NextPrevPosts").style.display = "none"
					} else {
						document.getElementById("NextPrevPosts").style.display = "block"
					}
				}
			</script>
			<script type='text/javascript' src='statics/js/jquery.min.js'></script>
			<script type='text/javascript' src='statics/js/plugins.js'></script>
			<script type='text/javascript' src='statics/js/script.js'></script>
			<script type='text/javascript' src='statics/js/particles.js'></script>
			<script type='text/javascript' src='statics/js/aos.js'></script>
			<script type='text/javascript' src='statics/js/prism.js'></script>
			<script type='text/javascript' src='statics/js/gravatar.js'></script>

	</body>

</html>